# 医管家后端接口规范（v1）

## 基础约定
- Base URL：`https://api.medmanager.example.com`
- 认证：HTTP Header `Authorization: Bearer <token>`（JWT），除登录与公开资源外均需携带。
- 请求头：`Content-Type: application/json`；文件上传使用 `multipart/form-data`。
- 时间与 ID：时间使用 ISO8601（示例 `2025-11-25T08:00:00Z`），`id` 使用字符串（建议 ULID）。
- 响应包裹：
  - 成功：`{ code: 0, message: "ok", data: <payload> }`
  - 失败：`{ code: <nonzero>, message: <string>, details?: <object> }`
- 分页：查询参数 `page`、`pageSize`；响应 `{ list: [], page, pageSize, total }`。

## 资源与端点

### 1. 成员 Members
来源：成员管理页与档案页使用的本地数据（参考 `src/pages/profile/family/manage.vue` 与 `src/pages/profile/index.vue`）。

- GET `/members`
  - 查询：`relation?`、`keyword?`
  - 响应：`{ list: Member[], page, pageSize, total }`
- POST `/members`
  - 请求：`MemberCreate`
  - 响应：`Member`
- GET `/members/:id`
- PUT `/members/:id`
  - 请求：`MemberUpdate`
  - 响应：`Member`
- DELETE `/members/:id`
- GET `/members/active`
  - 响应：`{ id: string, member: Member }`
- PATCH `/members/:id/active`
  - 响应：`{ id: string }`

数据结构：
```json
// Member
{
  "id": "self",
  "name": "我自己",
  "relation": "本人",
  "age": 32,
  "avatar": "https://...",
  "health": {
    "bloodType": "A",
    "allergies": "青霉素",
    "chronic": "高血压"
  }
}
```

### 2. 病历 Records（健康档案）
来源：病历时间轴与详情编辑（参考 `src/pages/files/*.vue`）。

- GET `/records`
  - 查询：`memberId?`、`dateFrom?`、`dateTo?`、`type?`、`keyword?`
  - 响应：`{ list: RecordMeta[], page, pageSize, total }`
- POST `/records`
  - 请求：`RecordCreate`
  - 响应：`Record`
- GET `/records/:id`
  - 响应：`Record`
- PUT `/records/:id`
  - 请求：`RecordUpdate`
  - 响应：`Record`
- DELETE `/records/:id`
- POST `/records/:id/images`
  - 上传：`multipart/form-data`，字段 `file`
  - 响应：`{ urls: string[] }`
- GET `/records/:id/images`
  - 响应：`{ urls: string[] }`
- POST `/records/:id/ai/interpret`
  - 请求：`{ prompt?: string }`
  - 响应：`{ aiSummary: string }`

数据结构：
```json
// RecordMeta
{
  "id": "rec_01",
  "memberId": "self",
  "date": "2025-11-20",
  "hospital": "市人民医院",
  "type": "门诊",
  "typeClass": "outpatient",
  "diagnosis": "急性咽炎",
  "doctor": "张三",
  "hasAI": true,
  "images": ["https://.../a.jpg"]
}

// Record（含结构化 detail）
{
  "detail": {
    "complaint": "咽痛一周",
    "history": "间断发热",
    "diagnosis": "急性咽炎",
    "department": "耳鼻喉科"
  }
}
```

### 3. 用药 Meds
来源：用药计划、打卡与搜索/OCR（参考 `src/pages/meds/*.vue`）。

#### 3.1 计划 Plans
- GET `/meds/plans`
  - 查询：`memberId?`
  - 响应：`{ list: Plan[], page, pageSize, total }`
- POST `/meds/plans`
  - 请求：`PlanCreate`
  - 响应：`Plan`
- GET `/meds/plans/:id`
- PUT `/meds/plans/:id`
  - 请求：`PlanUpdate`
  - 响应：`Plan`
- DELETE `/meds/plans/:id`

计划结构：
```json
{
  "id": "p_01",
  "memberId": "self",
  "name": "阿莫西林胶囊",
  "dose": "0.5g",
  "meal": "饭后",
  "freqLabel": "每日2次",
  "times": ["08:00", "20:00"],
  "startDate": "2025-11-25",
  "repeat": "daily",
  "notify": true
}
```

#### 3.2 当日任务 Tasks
- GET `/meds/tasks`
  - 查询：`date`、`memberId?`
  - 响应：`Task[]`（由计划派生）
- POST `/meds/tasks/:taskId/check`
  - 请求：`{ done: true, ts?: "2025-11-25T08:01:00Z" }`
  - 响应：`{ taskId: string, done: true }`

#### 3.3 搜索与 OCR（可选）
- GET `/meds/search?q=阿莫西林`
  - 响应：`{ list: [{ name, spec }], total }`
- POST `/meds/ocr`
  - 上传：`multipart/form-data` 字段 `file`
  - 响应：`{ name: string, spec?: string }`

### 4. 预约 Bookings
来源：抢号任务配置与列表（参考 `src/pages/booking/*.vue`）。

- GET `/bookings`
  - 查询：`memberId?`、`dateFrom?`、`dateTo?`
- POST `/bookings`
  - 请求：`BookingCreate`
- GET `/bookings/:id`
- PUT `/bookings/:id`
- DELETE `/bookings/:id`

结构示例：
```json
{
  "id": "b_01",
  "memberId": "self",
  "hospital": "市人民医院",
  "department": "皮肤科",
  "tag": "专家号",
  "link": "https://...",
  "strategy": { "aheadMins": 2, "autoOpen": true },
  "openTime": "2025-11-26T02:00:00Z"
}
```

### 5. 检查报告 Reports
来源：报告列表、详情与 AI 解读（参考 `src/pages/reports/*.vue`）。

- GET `/reports`
  - 查询：`memberId?`、`dateFrom?`、`dateTo?`
- POST `/reports`
- GET `/reports/:id`
- PUT `/reports/:id`
- DELETE `/reports/:id`
- GET `/reports/:id/metrics`
  - 响应：`Metric[]`
- POST `/reports/:id/metrics`
  - 请求：`Metric[]`
- GET `/reports/:id/trends`
  - 查询：`metric`、`range`
  - 响应：趋势点数组
- POST `/reports/:id/ai/interpret`
  - 响应：`{ aiText: string }`

Metric 示例：
```json
{ "name": "血红蛋白", "value": 108, "unit": "g/L", "reference": "115-150", "abnormal": true }
```

### 6. 费用 Bills 与统计 Stats
来源：费用列表与统计（参考 `src/pages/billing/*.vue`、`src/pages/stats/index.vue`）。

- GET `/bills`
  - 查询：`memberId?`、`dateFrom?`、`dateTo?`、`category?`、`insured?`
- POST `/bills`
- GET `/bills/:id`
- PUT `/bills/:id`
- DELETE `/bills/:id`
- GET `/bills/:id/items`
  - 响应：`BillItem[]`
- POST `/bills/:id/items`
  - 请求：`BillItem[]`
- GET `/stats/expenses`
  - 查询：`memberId?`、`dateFrom?`、`dateTo?`
  - 响应：按类别的金额与占比
- GET `/stats/health-trends`
  - 查询：`memberId?`、`metric`、`range`

BillItem 示例：
```json
{ "name": "血常规检查", "amount": 28.0, "insured": true }
```

### 7. 偏好 Preferences 与订阅 Subscriptions（可选）
来源：偏好设置与提醒订阅（参考 `src/pages/profile/index.vue`）。

- GET `/preferences`
- PUT `/preferences`
  - 请求：`{ elderlyMode: boolean, fontScale: number }`
- GET `/subscriptions`
- PUT `/subscriptions`
  - 请求：`{ meds: boolean, booking: boolean }`

## 鉴权与错误码建议
- 登录：`POST /auth/login`，响应 `{ token, user }`
- 刷新：`POST /auth/refresh`，响应 `{ token }`
- 常用错误码：
  - `401` 未认证；`403` 无权限；`404` 资源不存在
  - 业务错误以 `code` 提供细分：`1001` 参数错误、`2001` 资源冲突等

## 与前端页面的映射
- 成员管理：`src/pages/profile/family/manage.vue:10–25`、`src/pages/profile/index.vue`
- 病历：`src/pages/files/index.vue`、`new.vue`、`detail.vue`、`edit.vue`
- 用药：`src/pages/meds/index.vue`、`add.vue`、`plan.vue`
- 预约：`src/pages/booking/index.vue`、`new.vue`
- 报告：`src/pages/reports/index.vue`、`detail.vue`
- 费用：`src/pages/billing/index.vue`、`detail.vue`；统计 `src/pages/stats/index.vue`

## 备注
- 现有前端全部使用本地存储作为数据源；后端上线后建议采用“网络优先 + 本地缓存降级”的迁移策略。
